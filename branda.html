<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Brand A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .brand-a-bg { background-color: #D90429; }
        .brand-a-text { color: #D90429; }
        .brand-a-button {
            background-color: #D90429;
            transition: background-color 0.3s;
        }
        .brand-a-button:hover { background-color: #b70323; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white shadow-xl rounded-lg overflow-hidden max-w-md w-full">
        <!-- Header Image -->
        <img src="https://placehold.co/600x300/D90429/FFFFFF?text=Brand+A&font=inter" alt="Brand A Header" class="w-full h-48 object-cover">
        
        <div class="p-8 text-center">
            <!-- Logo -->
            <img src="https://placehold.co/150x40/D90429/FFFFFF?text=Brand+A&font=inter" alt="Brand A Logo" class="mx-auto mb-6 h-10">
            
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Brand A</h1>
            <p class="text-gray-600 mb-8">Your fiery partner in all things red.</p>
            
            <!-- This is the OIDC Login Button -->
            <a id="login-button" href="#" class="brand-a-button text-white font-bold py-3 px-8 rounded-lg text-lg inline-block shadow-lg">
                Login / Register
            </a>
            
            <!-- This section will display the auth code after redirect -->
            <div id="result" class="mt-8 p-4 bg-gray-50 rounded-lg text-left hidden">
                <h3 class="font-semibold text-gray-700">Authentication Success!</h3>
                <p class="text-sm text-gray-600">Your Authorization Code:</p>
                <code id="auth-code" class="text-xs text-blue-700 bg-blue-100 p-2 rounded block break-all"></code>
            </div>

            <!-- This section will display the token data -->
            <div id="token-display" class="mt-8 p-4 bg-gray-50 rounded-lg text-left hidden">
                <h3 class="font-semibold text-gray-700">Tokens Received!</h3>
                
                <p class="text-sm text-gray-600 mt-4 font-semibold">ID Token Claims:</p>
                <pre><code id="id-token-claims" class="text-xs text-green-700 bg-green-100 p-2 rounded block break-all overflow-x-auto"></code></pre>

                <p class="text-sm text-gray-600 mt-4 font-semibold">Access Token:</p>
                <code id="access-token" class="text-xs text-blue-700 bg-blue-100 p-2 rounded block break-all overflow-x-auto">...truncated...</code>
            </div>
        </div>
    </div>

    <script>
        // --- OIDC Configuration ---
        // !! REPLACE THESE VALUES !!
        const oktaDomain = "login.vinset.org"; // e.g., dev-12345.okta.com
        const clientId = "0oac6o0de1r4zYznU0x7";     // From the OIDC app you created
        // !! -------------------- !!
        
        // This should be the *final* URL of this page (e.g., from GitHub Pages)
        const redirectUri = window.location.href.split('?')[0];
        
        // --- PKCE Helper Functions ---

        // Function to generate a random string for the code verifier
        function generateCodeVerifier() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234G_~';
            let verifier = '';
            // Length must be between 43 and 128
            const length = Math.floor(Math.random() * (128 - 43 + 1)) + 43; 
            for (let i = 0; i < length; i++) {
                verifier += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return verifier;
        }

        // Function to generate the code challenge from the verifier (SHA-256 hash)
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // Convert buffer to Base64 URL-safe string
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            let base64 = btoa(String.fromCharCode.apply(null, hashArray));
            
            // Base64 URL encoding replacements
            base64 = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            
            return base64;
        }

        // --- JWT Parsing Helper ---
        // Decodes the ID token to show the claims
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base6LETTERS.map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error parsing JWT:", e);
                return { error: "Could not parse ID token." };
            }
        }

        // --- Token Exchange Function ---
        async function exchangeCodeForToken(code, verifier) {
            const tokenUrl = `https://${oktaDomain}/oauth2/default/v1/token`;
            
            const params = new URLSearchParams();
            params.append('grant_type', 'authorization_code');
            params.append('client_id', clientId);
            params.append('redirect_uri', redirectUri);
            params.append('code', code);
            params.append('code_verifier', verifier);

            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Token exchange failed: ${errorData.error_description || response.statusText}`);
                }

                const tokenData = await response.json();
                
                // Success! Display the tokens.
                document.getElementById('token-display').classList.remove('hidden');
                
                // Display Access Token
                document.getElementById('access-token').innerText = tokenData.access_token;
                
                // Parse and display ID Token claims
                const idTokenClaims = parseJwt(tokenData.id_token);
                document.getElementById('id-token-claims').innerText = JSON.stringify(idTokenClaims, null, 2);

                // Clean up session storage
                sessionStorage.removeItem('pkce_code_verifier');

            } catch (error) {
                console.error(error);
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('auth-code').innerText = `Error: ${error.message}`;
                document.getElementById('auth-code').style.color = 'red';
            }
        }

        // --- Main Async Function ---
        // We use an async IIFE (Immediately Invoked Function Expression)
        // to handle the 'await' for the code challenge generation.
        (async () => {
            // Check for an auth code in the URL first (on redirect)
            const params = new URLSearchParams(window.location.search);
            const authCode = params.get('code');

            if (authCode) {
                // We have an auth code! Exchange it for tokens.
                console.log("Authorization Code found:", authCode);
                document.getElementById('login-button').classList.add('hidden');
                
                const storedVerifier = sessionStorage.getItem('pkce_code_verifier');
                
                if (storedVerifier) {
                    console.log("Exchanging code for token with verifier:", storedVerifier);
                    // Call the new token exchange function
                    exchangeCodeForToken(authCode, storedVerifier);
                } else {
                    console.error("Error: PKCE verifier not found in session storage.");
                    document.getElementById('result').classList.remove('hidden');
                    document.getElementById('auth-code').innerText = "Error: PKCE verifier not found. Please try logging in again.";
                    document.getElementById('auth-code').style.color = 'red';
                }

            } else {
                // --- This runs on initial page load (before login) ---
                
                // 1. Generate and store the verifier
                const codeVerifier = generateCodeVerifier();
                sessionStorage.setItem('pkce_code_verifier', codeVerifier);

                // 2. Generate the challenge
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // 3. Construct the OIDC /authorize URL with PKCE params
                const authorizeUrl = `https://${oktaDomain}/oauth2/default/v1/authorize?` +
                    `response_type=code` +
                    `&client_id=${clientId}` +
                    `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                    `&scope=openid%20profile%20email%20phone` +
                    `&state=a-state-value` + // <-- State value for Brand A
                    `&brand=brand-a` + // <-- This is the magic parameter!
                    `&code_challenge=${codeChallenge}` + // <-- PKCE Fix
                    `&code_challenge_method=S256`;      // <-- PKCE Fix

                // 4. Set the link on the button
                document.getElementById('login-button').href = authorizeUrl;
            }
        })().catch(err => {
            console.error("PKCE Setup Error:", err);
            document.getElementById('login-button').innerText = "Error initializing login";
            document.getElementById('login-button').style.backgroundColor = "gray";
        });
        
    </script>
</body>
</html>

